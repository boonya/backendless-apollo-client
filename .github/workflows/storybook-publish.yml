name: Publishing storybook ðŸŽ¨

on:
  pull_request:
  push:
    branches:
      - main
      - wf # Do not forget to remove it

permissions:
  contents: write
  pull-requests: write

env:
  GH_PAGES_BRANCH: docs
  GH_PAGES_FOLDER: docs
  GH_PAGES_URL: ${{ github.event.repository.homepage }} # https://boonya.github.io/backendless-apollo-client/
  MD_FILE: index.md
  REPO_URL: ${{ github.event.repository.html_url }} # https://github.com/boonya/backendless-apollo-client
  REF_NAME: ${{ github.head_ref || github.ref_name }} # branch or tag name
  SHA: ${{ github.event.after }} # sha hash of head

jobs:
  debug:
    name: Debug
    runs-on: ubuntu-latest
    steps:
      # ref: refs/heads/wf
      # refs/heads/wf
      #
      # refs/heads/<branch_name>,
      # for pull requests it is refs/pull/<pr_number>/merge,
      # and for tags it is refs/tags/<tag_name>.
      - run: |
          echo "Debug step..."

          echo "GH_PAGES_BRANCH: ${GH_PAGES_BRANCH}"
          echo "GH_PAGES_FOLDER: ${GH_PAGES_FOLDER}"
          echo "GH_PAGES_URL: ${GH_PAGES_URL}"
          echo "MD_FILE: ${MD_FILE}"
          echo "REPO_URL: ${REPO_URL}"
          echo "REF_NAME: ${REF_NAME}"
          echo "SHA: ${SHA}"

          echo "github.event_name: ${{ github.event_name }}"
          echo "github.base_ref: ${{ github.base_ref }}"
          echo "github.head_ref: ${{ github.head_ref }}"
          echo "github.ref: ${{ github.ref }}"
          echo "github.ref_name: ${{ github.ref_name }}"

          echo "github.event.repository.homepage: ${{ github.event.repository.homepage }}"
          echo "github.event.repository.html_url: ${{ github.event.repository.html_url }}"
          echo "github.event.ref: ${{ github.event.ref }}"
          echo "github.event.pull_request.head.ref: ${{ github.event.pull_request.head.ref }}"
          echo "branch name: ${{ github.event.pull_request.head.ref || github.event.ref }}"
          echo "GITHUB_REF_NAME: ${GITHUB_REF_NAME}"
          echo "GITHUB_REF: ${GITHUB_REF}"

          echo "env.REF_NAME: ${{ env.REF_NAME }}"
          echo "REF_NAME: ${REF_NAME}"

          ROOT_DIR=`echo ${GITHUB_REPOSITORY} | sed -e "s/^${GITHUB_REPOSITORY_OWNER}\///"`
          echo "APP_PREFIX: /${ROOT_DIR}/${REF_NAME}"
          echo "STORYBOOK_STATIC_TARGET: /${GH_PAGES_FOLDER}/${REF_NAME}"

          SANITIZED_REF_NAME=$(printf '%s\n' "${REF_NAME}" | sed -e 's/[\/&]/\\&/g')
          echo "| [${REF_NAME}](${GH_PAGES_URL}${REF_NAME}) | [\`${SHA}\`](${REPO_URL}/tree/${SHA}) |"

          SANITIZED_REF_NAME=$(printf '%s\n' "${REF_NAME}" | sed -e 's/[\/&]/\\&/g')
          echo "| [${REF_NAME}](${GH_PAGES_URL}${REF_NAME}) | [\[#${{ github.event.pull_request.number }}\] ${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }}) |"

      - run: |
          echo "github: ${{ toJSON(github) }}"
      - run: |
          echo "github.event: ${{ toJSON(github.event) }}"

  publish:
    name: Checkout, build & publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: ".nvmrc"
      - name: "Prepare variables"
        run: |
          echo "APP_PREFIX=/${{ github.event.pull_request.base.repo.name }}/${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
          echo "STORYBOOK_STATIC_TARGET=/${GH_PAGES_FOLDER}/${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
      - run: npm ci
      - name: "Run storybook build"
        run: APP_PREFIX=${APP_PREFIX} npm run storybook:build
      - name: "Publish bundle"
        uses: JamesIves/github-pages-deploy-action@v4.4.1
        with:
          branch: ${{ env.GH_PAGES_BRANCH }}
          folder: storybook-static
          target-folder: ${{ env.STORYBOOK_STATIC_TARGET }}

  readme:
    needs: publish
    name: "Update a catalog"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ env.GH_PAGES_BRANCH }}
      - name: "Update a catalog file"
        run: |
          SANITIZED_REF_NAME=$(printf '%s\n' "${{ github.event.pull_request.head.ref }}" | sed -e 's/[\/&]/\\&/g')
          sed -i "/\[${SANITIZED_REF_NAME}\]/d" ${GH_PAGES_FOLDER}/${MD_FILE}
          echo "| [${{ github.event.pull_request.head.ref }}](${{ github.event.pull_request.base.repo.homepage }}${{ github.event.pull_request.head.ref }}) | [\[#${{ github.event.pull_request.number }}\] ${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }}) |" >> ${GH_PAGES_FOLDER}/${MD_FILE}
      - name: "Publish changes"
        uses: JamesIves/github-pages-deploy-action@v4.4.1
        with:
          branch: ${{ env.GH_PAGES_BRANCH }}
          folder: ${{ env.GH_PAGES_FOLDER }}
          target-folder: ${{ env.GH_PAGES_FOLDER }}

  comment:
    needs: publish
    if: ${{ github.event_name == 'pull_request' }}
    name: "Add a comment to the PR"
    runs-on: ubuntu-latest
    steps:
      - name: Find Comment
        uses: peter-evans/find-comment@v2
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: instance of storybook deployed
      - name: Create of update a comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: replace
          body: |
            ### You can play with these changes at [the separate instance of storybook deployed.][1]
            [1]: ${{ github.event.pull_request.base.repo.homepage }}${{ github.event.pull_request.head.ref }}
          reactions: rocket
